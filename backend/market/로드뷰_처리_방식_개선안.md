# 로드뷰 처리 방식 개선안

## 현재 문제점

1. **카카오 로드뷰는 서버 사이드에서 직접 호출 불가**
   - JavaScript API만 제공
   - 서버 사이드 REST API 없음

2. **현재 구조의 애매함**
   - `orchestrator.js`에서 로드뷰 분석을 백엔드에서 호출하려고 함
   - 하지만 카카오 로드뷰는 프론트엔드에서만 접근 가능
   - AI 분석은 서버 사이드에서 해야 함

---

## 개선 방안

### 방안 1: 하이브리드 방식 (권장) ✅

**프론트엔드와 백엔드 분리**:

#### 프론트엔드 역할
- 카카오 로드뷰 JavaScript API로 로드뷰 표시
- 사용자가 로드뷰 확인
- 로드뷰 이미지 캡처 (선택사항)

#### 백엔드 역할
- Google Street View Static API로 로드뷰 이미지 가져오기
- Gemini Vision API로 이미지 분석
- 분석 결과 반환

**장점**:
- 프론트엔드에서 자연스럽게 로드뷰 표시
- 백엔드에서 AI 분석 수행
- 각자의 역할이 명확함

---

### 방안 2: 프론트엔드에서 이미지 전송

**프론트엔드**:
1. 카카오 로드뷰 JavaScript API로 로드뷰 표시
2. Canvas API로 로드뷰 이미지 캡처
3. Base64로 인코딩하여 서버로 전송

**백엔드**:
1. Base64 이미지 수신
2. Gemini Vision API로 분석
3. 분석 결과 반환

**단점**:
- 이미지 전송으로 인한 네트워크 부하
- 프론트엔드 구현 복잡도 증가

---

### 방안 3: Google Street View만 사용

**백엔드**:
- Google Street View Static API로 로드뷰 이미지 가져오기
- Gemini Vision API로 분석
- 분석 결과 반환

**프론트엔드**:
- Google Street View를 표시 (카카오 로드뷰 대신)

**장점**:
- 서버 사이드에서 모든 처리 가능
- 구현이 단순함

**단점**:
- 카카오 로드뷰를 사용할 수 없음
- Google Street View API 키 필요

---

## 권장 구현 방식

### 1단계: 백엔드 - Google Street View로 AI 분석

```javascript
// backend/services/orchestrator.js
// 3. 로드뷰 분석
let roadview;
try {
  // Google Street View API로 로드뷰 이미지 가져오기
  const { getRoadviewImageUrl } = require('../market/roadviewApi');
  const roadviewInfo = await getRoadviewImageUrl(location);
  
  // Gemini Vision API로 분석 (ai/roadview 모듈)
  const { analyzeRoadview } = require('../../ai/roadview');
  roadview = await analyzeRoadview({
    location,
    imageUrl: roadviewInfo.imageUrl, // Google Street View 이미지 URL
    source: roadviewInfo.source
  });
} catch (error) {
  // 실패 시 기본값 사용
  roadview = {
    location: { lat: location.lat, lng: location.lng },
    risks: [],
    overallRisk: 'medium',
    riskScore: 65
  };
}
```

### 2단계: 프론트엔드 - 카카오 로드뷰 표시 (선택사항)

```html
<!-- frontend/input/index.html -->
<div id="roadview-container"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY&libraries=services"></script>
<script>
  // 카카오 로드뷰 표시
  const roadview = new kakao.maps.Roadview(document.getElementById('roadview-container'));
  const roadviewClient = new kakao.maps.RoadviewClient();
  
  // 분석 결과의 location으로 로드뷰 표시
  const location = { lat: 37.4980, lng: 127.0276 };
  roadviewClient.getNearestPanoId(location.lng, location.lat, 50, function(panoId) {
    roadview.setPanoId(panoId, 0);
  });
</script>
```

---

## 최종 권장사항

### 백엔드 (현재 구조 유지)
- ✅ Google Street View Static API 사용
- ✅ Gemini Vision API로 분석
- ✅ 분석 결과를 `roadview` 필드로 반환

### 프론트엔드 (추가 구현)
- ✅ 카카오 로드뷰 JavaScript API로 로드뷰 표시
- ✅ 분석 결과와 함께 로드뷰 표시
- ⚠️ 로드뷰 이미지 캡처는 선택사항 (필요시만)

---

## 구조 개선

### 현재 구조
```
프론트엔드 → 백엔드 → 카카오 로드뷰 (불가능)
```

### 개선된 구조
```
프론트엔드 → 카카오 로드뷰 JavaScript API (표시)
백엔드 → Google Street View → Gemini Vision (분석)
```

---

## 역할 분담 (최종)

### 1. 백엔드 (`orchestrator.js`)
- Google Street View API로 로드뷰 이미지 URL 가져오기
- `ai/roadview` 모듈에 이미지 URL 전달
- 분석 결과를 최종 결과에 포함

### 2. AI-로드뷰 모듈 (`ai/roadview`)
- **입력**: 이미지 URL + location
- **처리**: 
  - 이미지 URL에서 이미지 다운로드
  - Gemini Vision API로 이미지 분석
  - 분석 결과를 구조화된 형식으로 변환
- **출력**: risks, overallRisk, riskScore

### 3. 프론트엔드
- ✅ **카카오 로드뷰 JavaScript API로 사용자에게 로드뷰 표시**
- 분석 결과와 함께 로드뷰 표시
- 상세 구현 가이드: `frontend/카카오_로드뷰_구현_가이드.md` 참고

---

## 결론

**각자의 역할이 명확합니다!**

- **백엔드**: Google Street View URL 생성 → `ai/roadview` 모듈 호출
- **AI-로드뷰**: 이미지 다운로드 → Gemini Vision 분석 → 결과 반환
- **프론트엔드**: 카카오 로드뷰 JavaScript API로 사용자에게 표시

이렇게 하면 각자의 역할이 명확하고, 자연스러운 구조가 됩니다.
