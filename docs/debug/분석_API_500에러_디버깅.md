# 분석 API 500 에러 디버깅 가이드

## 현재 상황

프론트엔드에서 분석 실행 시 `/api/analyze` 엔드포인트에서 500 에러가 발생합니다.

## 확인 사항

### 1. 서버 로그 확인

서버를 실행한 터미널에서 다음 로그를 확인하세요:

```
[분석 요청] 요청 받음
[분석 요청] 요청 본문: {...}
[분석 요청] 입력 검증 시작: {...}
[분석 요청] 분석 ID 생성: analysis_xxx
[분석 요청] DB 저장 시작...
[분석 요청] DB 저장 완료
[분석 요청] 분석 실행 시작...
[분석 요청] 응답 전송: analysis_xxx
```

또는 에러가 발생하면:

```
[분석 요청] 오류 발생: ...
[분석 요청] 오류 메시지: ...
[분석 요청] 오류 스택: ...
```

### 2. 프론트엔드에서 보내는 데이터 형식

프론트엔드 `script.js`에서 보내는 데이터:

```javascript
{
  brandId: brand.id,              // 문자열 (예: "brand_1")
  location: {                     // 객체
    lat: 37.498,
    lng: 127.0276,
    address: "서울특별시 강남구 강남대로 396"
  },
  radius: 500,                    // 숫자
  conditions: {                   // 객체
    initialInvestment: 120000000, // 숫자 (만원 * 10000)
    monthlyRent: 3000000,         // 숫자 (만원 * 10000)
    area: 15,                     // 숫자
    ownerWorking: true            // 불린
  },
  targetDailySales: 200           // 숫자
}
```

### 3. 가능한 원인

1. **DB 연결 오류**
   - PostgreSQL이 실행 중인지 확인
   - `.env` 파일의 DB 설정 확인

2. **브랜드 ID 오류**
   - `brandId`가 DB에 존재하는지 확인
   - 브랜드 선택 페이지에서 올바른 ID가 전달되는지 확인

3. **데이터 형식 오류**
   - `location` 객체가 올바른 형식인지 확인
   - 숫자 필드가 올바르게 파싱되었는지 확인

4. **필수 필드 누락**
   - `brandId`, `location`, `conditions`, `targetDailySales` 모두 필수

## 해결 방법

### 1단계: 서버 로그 확인

서버를 실행한 터미널에서 `[분석 요청]`으로 시작하는 로그를 확인하세요.

### 2단계: 브라우저 콘솔 확인

브라우저 개발자 도구(F12) → Network 탭에서:
1. `/api/analyze` 요청 클릭
2. Request Payload 확인 (보내는 데이터)
3. Response 확인 (에러 메시지)

### 3단계: DB 확인

```bash
# PostgreSQL 접속
psql -U postgres -d startsmart

# 브랜드 확인
SELECT id, name FROM brands LIMIT 5;

# 최근 분석 요청 확인
SELECT id, brand_id, status, error_message FROM analyses ORDER BY created_at DESC LIMIT 5;
```

## 다음 단계

서버 로그를 확인한 후, 구체적인 에러 메시지를 알려주시면 추가로 도와드리겠습니다.
