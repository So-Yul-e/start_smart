# 분석 성능 최적화 가이드

## 현재 상황

분석 시간이 너무 오래 걸리는 문제가 발생했습니다. 백엔드만 테스트했을 때는 정상 작동했지만, 프론트엔드와 연동 시 문제가 발생했습니다.

## 적용된 최적화

### 1. 각 단계별 시간 측정
- 각 분석 단계(상권 분석, 손익 계산, 로드뷰 분석, AI 컨설팅, 판단 계산)의 소요 시간을 측정하여 로그에 출력
- 병목 지점을 쉽게 파악할 수 있도록 개선

### 2. AI 컨설팅 타임아웃 설정
- AI 컨설팅에 30초 타임아웃 추가
- 타임아웃 발생 시 기본값 사용하여 전체 분석이 실패하지 않도록 처리

## 각 단계별 예상 소요 시간

1. **상권 분석** (analyzeMarket)
   - Map API 호출 (Kakao, Naver, Google)
   - 예상: 2-5초

2. **손익 계산** (calculateFinance)
   - 로컬 계산
   - 예상: < 1초

3. **로드뷰 분석** (getRoadviewImageUrl + analyzeRoadview)
   - Google Street View API 호출
   - Gemini Vision API 호출 (이미지 분석)
   - 예상: 5-15초

4. **AI 컨설팅** (generateConsulting)
   - Claude API 호출 (여러 프롬프트 병렬 처리)
   - 예상: 10-30초 (타임아웃: 30초)

5. **판단 계산** (calculateDecision)
   - 로컬 계산
   - 예상: < 1초

**총 예상 시간**: 20-50초

## 성능 모니터링 방법

### 서버 콘솔 확인
서버를 실행한 터미널에서 다음과 같은 로그를 확인할 수 있습니다:

```
[analysis_xxx] 🚀 분석 시작...
[analysis_xxx] 📊 1/5 상권 분석 시작...
[analysis_xxx] ✅ 상권 분석 완료 (3.45초)
[analysis_xxx] 💰 2/5 손익 계산 시작...
[analysis_xxx] ✅ 손익 계산 완료 (0.12초)
[analysis_xxx] 🗺️ 3/5 로드뷰 분석 시작...
[analysis_xxx] ✅ 로드뷰 분석 완료 (8.23초, 소스: google)
[analysis_xxx] 🤖 4/5 AI 컨설팅 생성 시작...
[analysis_xxx] ✅ AI 컨설팅 생성 완료 (15.67초)
[analysis_xxx] ⚖️ 5/5 판단 계산 시작...
[analysis_xxx] ✅ 판단 계산 완료 (0.34초)
[analysis_xxx] 🎉 분석 완료! (총 28.81초 소요)
```

### 병목 지점 파악
- 각 단계별 소요 시간을 비교하여 가장 오래 걸리는 단계를 확인
- 특정 단계가 예상보다 오래 걸리면 해당 API나 모듈을 최적화

## 추가 최적화 방안

### 1. AI 컨설팅 최적화
- 프롬프트 길이 단축
- 병렬 처리 최적화
- 캐싱 도입 (동일한 입력에 대해 캐시된 결과 사용)

### 2. 상권 분석 최적화
- Map API 호출 순서 최적화 (가장 빠른 API 우선)
- 실패 시 빠른 폴백
- 캐싱 도입 (동일한 위치/반경에 대해 캐시된 결과 사용)

### 3. 로드뷰 분석 최적화
- 이미지 다운로드 최적화
- Gemini Vision API 호출 최적화
- 실패 시 빠른 폴백

### 4. 비동기 처리 개선
- 가능한 단계를 병렬 처리
- 진행 상황을 중간 중간 업데이트하여 프론트엔드에 전달

## 문제 해결 체크리스트

1. ✅ 각 단계별 시간 측정 로깅 추가
2. ✅ AI 컨설팅 타임아웃 설정
3. ⏳ 서버 로그 확인하여 병목 지점 파악
4. ⏳ 병목 지점별 최적화 적용
5. ⏳ 프론트엔드 타임아웃 조정 (현재 2분)

## 다음 단계

1. 서버를 재시작하고 분석을 실행
2. 서버 콘솔에서 각 단계별 소요 시간 확인
3. 가장 오래 걸리는 단계를 파악
4. 해당 단계를 최적화하거나 타임아웃 조정
