# 리포트 생성 오류 디버깅 가이드

## 현재 상황

리포트 생성 API (`POST /api/report/:analysisId`)에서 500 에러가 발생하고 있습니다.

## 확인 방법

### 1. 서버 재시작 (필수!)

변경사항을 반영하려면 **서버를 재시작**해야 합니다:

```bash
# 서버 중지 (Ctrl+C)
# 서버 재시작
npm start
```

### 2. 서버 로그 확인

리포트 생성 시도 시 서버 콘솔에 다음 로그가 출력됩니다:

```
[리포트 생성] 분석 ID: analysis_xxxxx
[리포트 생성] 분석 조회 결과: { found: true, status: 'completed', ... }
[리포트 생성] result 데이터 확인: { hasId: true, hasBrand: true, ... }
```

또는 오류 발생 시:
```
[리포트 생성] result가 없습니다. analysis 객체: [...]
리포트 생성 오류: ...
스택 트레이스: ...
```

### 3. 수동 테스트

서버가 실행 중일 때:

```bash
# 분석 ID를 사용하여 리포트 생성 테스트
curl -X POST http://localhost:3000/api/report/analysis_1769863208093_sp88epc5s
```

## 예상 원인

1. **서버가 재시작되지 않음**: 변경사항이 반영되지 않음
2. **result 필드가 null**: DB에 결과가 제대로 저장되지 않음
3. **JSONB 파싱 문제**: PostgreSQL에서 JSONB를 조회할 때 형식 문제

## 해결 방법

### 방법 1: 서버 재시작 후 테스트

```bash
# 1. 서버 재시작
npm start

# 2. 다른 터미널에서 테스트
npm run test:flow
```

### 방법 2: 서버 로그 확인

서버 콘솔에서 `[리포트 생성]`으로 시작하는 로그를 확인하여 정확한 오류 원인 파악

### 방법 3: DB 직접 확인

```sql
-- 최근 분석 결과 확인
SELECT id, status, result IS NULL as result_null
FROM analyses 
ORDER BY created_at DESC 
LIMIT 1;

-- result 데이터 확인 (일부만)
SELECT id, status, 
       CASE 
         WHEN result IS NULL THEN 'NULL'
         WHEN jsonb_typeof(result) = 'object' THEN 'object'
         ELSE 'other'
       END as result_type
FROM analyses 
ORDER BY created_at DESC 
LIMIT 1;
```

## 다음 단계

서버를 재시작한 후 다시 테스트해보시고, 서버 로그를 확인해주세요!
