# 전체 플로우 테스트 가이드

## 개요

프론트엔드와 백엔드 연동을 확인하고 전체 플로우를 테스트하는 가이드입니다.

---

## 사전 준비

### 1. 환경변수 확인

`.env` 파일에 다음 항목이 설정되어 있는지 확인:

```bash
PORT=3000
HOST=localhost  # 또는 로컬 IP (172.16.48.47)
GEMINI_API_KEY=xxxxx
KAKAO_REST_API_KEY=xxxxx
DB_HOST=localhost
DB_PORT=5432
DB_NAME=startsmart
DB_USER=postgres
DB_PASSWORD=xxxxx
```

### 2. 데이터베이스 확인

PostgreSQL이 실행 중이고, 브랜드 데이터가 있는지 확인:

```bash
# PostgreSQL 접속
psql -U postgres -d startsmart

# 브랜드 데이터 확인
SELECT id, name FROM brands LIMIT 5;
```

### 3. 의존성 설치

```bash
npm install
```

---

## 테스트 방법

### 방법 1: 자동화된 전체 플로우 테스트 (권장)

백엔드 서버를 실행한 상태에서:

```bash
# 터미널 1: 백엔드 서버 실행
npm start
# 또는
node backend/server.js

# 터미널 2: 전체 플로우 테스트 실행
npm run test:flow
# 또는
node backend/test-full-flow.js
```

**테스트 항목**:
1. ✅ 헬스 체크 (`/health`)
2. ✅ 브랜드 목록 조회 (`/api/brands`)
3. ✅ 분석 실행 (`/api/analyze`)
4. ✅ 분석 결과 조회 (`/api/result/:analysisId`) - 폴링
5. ✅ 결과 데이터 검증
6. ✅ 리포트 생성 (`/api/report/:analysisId`)

### 방법 2: 수동 테스트 (브라우저)

#### 1단계: 백엔드 서버 실행

```bash
npm start
```

서버가 정상 실행되면:
```
🚀 Server running on http://localhost:3000
📊 Health check: http://localhost:3000/health
```

#### 2단계: 브라우저에서 접속

1. **메인 페이지**: `http://localhost:3000/`
2. **브랜드 선택**: `http://localhost:3000/brand/`
3. **조건 입력**: `http://localhost:3000/input/`
4. **결과 대시보드**: `http://localhost:3000/dashboard/`
5. **리포트**: `http://localhost:3000/report/`

#### 3단계: 전체 플로우 테스트

1. **브랜드 선택**
   - 메인 페이지에서 "Start Journey" 클릭
   - 브랜드 카드 클릭
   - 브랜드 정보가 세션에 저장되는지 확인

2. **조건 입력**
   - 지도에서 위치 선택
   - 초기 투자금, 월세, 평수, 점주 근무 여부 입력
   - 목표 일 판매량 입력
   - "분석 시작" 버튼 클릭

3. **분석 진행**
   - 로딩 화면 표시 확인
   - 분석 ID가 생성되는지 확인
   - 결과 폴링이 정상 작동하는지 확인

4. **결과 확인**
   - 대시보드에 결과 표시 확인
   - 점수, 신호등, 차트 등이 정상 표시되는지 확인
   - AI 컨설팅 내용이 표시되는지 확인

5. **리포트 생성**
   - 리포트 페이지에서 PDF 생성 확인
   - 리포트 내용이 정상인지 확인

---

## 문제 해결

### 문제 1: 서버가 시작되지 않음

**증상**:
```
Error: listen EADDRINUSE: address already in use :::3000
```

**해결**:
```bash
# 포트 3000을 사용하는 프로세스 종료
lsof -ti:3000 | xargs kill -9

# 또는 다른 포트 사용
PORT=3001 npm start
```

### 문제 2: 브랜드 목록이 비어있음

**증상**: `/api/brands` 응답이 빈 배열

**해결**:
```bash
# DB에 브랜드 데이터가 있는지 확인
psql -U postgres -d startsmart -c "SELECT COUNT(*) FROM brands;"

# 데이터가 없으면 PDF에서 데이터 import
node backend/db/importFromPDFs.js
```

### 문제 3: 분석이 완료되지 않음

**증상**: 분석이 계속 "processing" 상태

**원인 확인**:
1. 로그 확인:
   ```bash
   # 서버 로그에서 오류 확인
   ```

2. API 키 확인:
   - `GEMINI_API_KEY`가 설정되어 있는지
   - `KAKAO_REST_API_KEY`가 설정되어 있는지

3. DB 연결 확인:
   - PostgreSQL이 실행 중인지
   - `.env`의 DB 정보가 올바른지

### 문제 4: CORS 오류

**증상**: 브라우저 콘솔에 CORS 오류

**해결**:
- `backend/server.js`에서 CORS가 활성화되어 있는지 확인
- 프론트엔드의 `API_BASE_URL`이 올바른지 확인

### 문제 5: 프론트엔드에서 API 호출 실패

**증상**: 네트워크 오류 또는 404

**확인 사항**:
1. `frontend/config.js`의 `API_BASE_URL` 확인
2. HTML에서 `window.API_BASE_URL` 설정 확인:
   ```html
   <script>
     window.API_BASE_URL = 'http://localhost:3000';
   </script>
   <script src="config.js"></script>
   ```

---

## 테스트 체크리스트

### 백엔드 API 테스트

- [ ] `/health` - 헬스 체크 정상 응답
- [ ] `/api/brands` - 브랜드 목록 조회 성공
- [ ] `/api/analyze` - 분석 요청 성공 (analysisId 반환)
- [ ] `/api/result/:analysisId` - 결과 조회 성공 (폴링)
- [ ] `/api/report/:analysisId` - 리포트 생성 성공

### 프론트엔드 플로우 테스트

- [ ] 메인 페이지 로드
- [ ] 브랜드 선택 페이지 로드
- [ ] 브랜드 카드 클릭 시 세션 저장
- [ ] 조건 입력 페이지 로드
- [ ] 지도 표시 및 위치 선택
- [ ] 폼 입력 및 검증
- [ ] 분석 시작 버튼 클릭
- [ ] 로딩 화면 표시
- [ ] 결과 대시보드 표시
- [ ] 리포트 생성 및 다운로드

### 데이터 검증

- [ ] 브랜드 정보가 정확히 표시되는지
- [ ] 분석 결과의 모든 필드가 존재하는지
- [ ] 점수 계산이 정확한지
- [ ] AI 컨설팅 내용이 생성되는지
- [ ] 상권 분석 결과가 정확한지

---

## 예상 실행 시간

- **헬스 체크**: < 1초
- **브랜드 목록 조회**: < 1초
- **분석 실행**: 5-30초 (API 호출 및 계산 시간)
- **결과 조회**: 분석 완료까지 폴링 (최대 10회 시도, 2초 간격)
- **리포트 생성**: 1-3초

**전체 플로우**: 약 10-40초

---

## 다음 단계

전체 플로우 테스트가 성공하면:

1. ✅ 프론트엔드-백엔드 연동 확인 완료
2. ✅ 맵 기능 고도화 진행 가능
3. ✅ 카카오 로드뷰 구현 진행 가능
4. ✅ 추가 기능 개발 진행 가능

---

## 참고

- 백엔드 통합 테스트: `npm run test:integration`
- 전체 플로우 테스트: `npm run test:flow`
- 서버 실행: `npm start`
